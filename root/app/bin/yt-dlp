#!/bin/bash

LOCK_FILE="/tmp/yt-dlp.lock"

exec 200> "$LOCK_FILE"

# acquiring lock using flock...
# -x: get an exclusive lock
# -w <secs>: wait for a limited amount of time
if ! flock -x -w 10 200; then
    echo "ERROR: Another instance of yt-dlp is already running. Timed out after 10 seconds..."
    exit 1
fi

cd /down || exit 1 # better run yt-dlp with --paths to be free from permission error

s6-setuidgid abc /usr/local/bin/yt-dlp "$@" || exit $?

if find /down/ -mindepth 1 -print -quit 2>/dev/null | grep -q .; then
    echo "[rsync] executing => rsync -a --remove-source-files /down/ /downloads/"
    rsync -a --remove-source-files /down/ /downloads/ && \
        find /down/ -mindepth 1 -depth -type d -empty -delete
    echo "[rsync] finished"
fi
